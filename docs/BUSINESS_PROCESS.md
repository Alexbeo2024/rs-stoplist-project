# üîÑ **–ë–ò–ó–ù–ï–°-–ü–†–û–¶–ï–°–° –ê–í–¢–û–ú–ê–¢–ò–ó–ò–†–û–í–ê–ù–ù–û–ô –°–ò–°–¢–ï–ú–´**

*–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Excel-—Ñ–∞–π–ª–æ–≤ –∏–∑ email –≤–ª–æ–∂–µ–Ω–∏–π*

---

## üìã **–û–ë–ó–û–† –ü–†–û–¶–ï–°–°–ê**

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–æ—á—Ç—É, –∏–∑–≤–ª–µ–∫–∞–µ—Ç Excel-—Ñ–∞–π–ª—ã –∏–∑ –≤–ª–æ–∂–µ–Ω–∏–π, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∏—Ö –≤ CSV —Ñ–æ—Ä–º–∞—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞ SFTP —Å–µ—Ä–≤–µ—Ä —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω.

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** Email —Å Excel –≤–ª–æ–∂–µ–Ω–∏—è–º–∏ (.xlsx)
**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** CSV —Ñ–∞–π–ª—ã –Ω–∞ SFTP —Å–µ—Ä–≤–µ—Ä–µ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞–ø–∫–∞—Ö
**–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥—ã–π —á–∞—Å (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
**–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** Retry –ª–æ–≥–∏–∫–∞, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏

---

## üéØ **–¶–ï–õ–ò –ò –ó–ê–î–ê–ß–ò**

### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏:**
- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** —Ä—É—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Excel —Ñ–∞–π–ª–æ–≤
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è** —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö (CSV —Å UTF-8 BOM)
- **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è** —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### **–†–µ—à–∞–µ–º—ã–µ –∑–∞–¥–∞—á–∏:**
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ —Ñ–∞–∫—Ç–æ—Ä–∞
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∞—É–¥–∏—Ç–∞ –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

---

## üîÑ **–ü–û–õ–ù–´–ô –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ**

```mermaid
graph TD
    A[üìß Email Monitoring] --> B{üìé Excel —Ñ–∞–π–ª?}
    B -->|–î–∞| C[üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞]
    B -->|–ù–µ—Ç| A
    C --> D[üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏]
    D --> E{üÜî –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω?}
    E -->|–î–∞| F[‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫ —Ñ–∞–π–ª–∞]
    E -->|–ù–µ—Ç| G[üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Excel‚ÜíCSV]
    G --> H[üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫]
    H --> I[üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ SFTP]
    I --> J[‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏]
    J --> K[üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö]
    K --> L[üì® –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π]
    L --> M[üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫]
    F --> A
    M --> A
```

---

## üìß **–®–ê–ì 1: EMAIL –ú–û–ù–ò–¢–û–†–ò–ù–ì**

### **–ü—Ä–æ—Ü–µ—Å—Å:**
1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ IMAP —Å–µ—Ä–≤–µ—Ä—É** –∫–∞–∂–¥—ã–π —á–∞—Å (–ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é)
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –ø–∏—Å–µ–º** –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–æ—á—Ç–æ–≤–æ–º —è—â–∏–∫–µ
3. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ whitelist** –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π
4. **–ü–æ–∏—Å–∫ –≤–ª–æ–∂–µ–Ω–∏–π** —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º `.xlsx`

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥ –ø—Ä–æ—Ü–µ—Å—Å–∞
async def monitor_emails():
    async with IMAPClient(config.email.server) as client:
        await client.login(config.email.username, config.email.password)

        # –ü–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –ø–∏—Å–µ–º
        new_emails = await client.search_new_emails()

        for email in new_emails:
            if email.sender in config.allowed_senders:
                for attachment in email.attachments:
                    if attachment.filename.endswith('.xlsx'):
                        yield EmailWithAttachment(email, attachment)
```

### **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–±–æ—Ä–∞:**
- **–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å** –≤ whitelist (config.yaml)
- **–ù–∞–ª–∏—á–∏–µ .xlsx –≤–ª–æ–∂–µ–Ω–∏–π**
- **–ü–∏—Å—å–º–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–∞–Ω–µ–µ** (–ø–æ Message-ID)

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- –¢–∞–π–º–∞—É—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Üí Retry —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
- –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Üí –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –°–µ—Ç–µ–≤—ã–µ —Å–±–æ–∏ ‚Üí Exponential backoff

---

## üîç **–®–ê–ì 2: –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø –ò –í–ê–õ–ò–î–ê–¶–ò–Ø**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Message-ID
SELECT COUNT(*) FROM processed_files
WHERE message_id = '${email.message_id}'
  AND file_name = '${attachment.filename}'
```

### **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞:**
- **–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞** < 50MB (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- **–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞** –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ Excel (.xlsx)
- **–§–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω** (–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏—è)

### **–õ–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π:**
```python
if file_already_processed(message_id, filename):
    log_info("File already processed, skipping")
    send_metrics("file_skipped_duplicate")
    continue

if not validate_excel_file(file_content):
    log_error("Invalid Excel file")
    send_alert("Invalid file received")
    continue

# –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
```

---

## üîÑ **–®–ê–ì 3: –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø EXCEL ‚Üí CSV**

### **–ü—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:**
1. **–ó–∞–≥—Ä—É–∑–∫–∞ Excel —Ñ–∞–π–ª–∞** –≤ –ø–∞–º—è—Ç—å
2. **–ß—Ç–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞** (–∏–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Å—Ç–∞)
3. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ CSV** —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:
   - –ö–æ–¥–∏—Ä–æ–≤–∫–∞: `UTF-8 with BOM`
   - –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: `,` (–∑–∞–ø—è—Ç–∞—è)
   - –ö–∞–≤—ã—á–∫–∏: –ü–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
4. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞**: `RS_stoplist_{YYYYMMDD}.csv`

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
```python
import pandas as pd
from datetime import datetime

def convert_excel_to_csv(excel_content: bytes, email_date: datetime) -> str:
    # –ó–∞–≥—Ä—É–∂–∞–µ–º Excel
    df = pd.read_excel(excel_content, engine='openpyxl')

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
    date_str = email_date.strftime('%Y%m%d')
    csv_filename = f"RS_stoplist_{date_str}.csv"

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º CSV
    df.to_csv(
        csv_filename,
        encoding='utf-8-sig',  # UTF-8 with BOM
        sep=',',
        index=False,
        quoting=csv.QUOTE_MINIMAL
    )

    return csv_filename
```

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö:**
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª** –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–π
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤**
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

---

## üìÅ **–®–ê–ì 4: –°–û–ó–î–ê–ù–ò–ï –°–¢–†–£–ö–¢–£–†–´ –ü–ê–ü–û–ö**

### **–ò–µ—Ä–∞—Ä—Ö–∏—è –ø–∞–ø–æ–∫:**
```
/upload/excel-files/
‚îú‚îÄ‚îÄ ps/
‚îÇ   ‚îî‚îÄ‚îÄ 2024/
‚îÇ       ‚îî‚îÄ‚îÄ 01/
‚îÇ           ‚îî‚îÄ‚îÄ 15/
‚îÇ               ‚îî‚îÄ‚îÄ RS_stoplist_20240115.csv
‚îÇ               ‚îî‚îÄ‚îÄ RS_stoplist_20240115.csv.meta
‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îú‚îÄ‚îÄ success/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 2024-01-15-processing.log
‚îÇ   ‚îî‚îÄ‚îÄ errors/
‚îÇ       ‚îî‚îÄ‚îÄ 2024-01-15-errors.log
‚îî‚îÄ‚îÄ archive/
    ‚îî‚îÄ‚îÄ 2024/
        ‚îî‚îÄ‚îÄ 01/
            ‚îî‚îÄ‚îÄ original_files/
```

### **–õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–æ–∫:**
```python
def build_remote_path(email_date: datetime) -> str:
    year = email_date.year
    month = f"{email_date.month:02d}"
    day = f"{email_date.day:02d}"

    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞: ps/YYYY/MM/DD/
    return f"ps/{year}/{month}/{day}/"
```

### **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞:**
–í–º–µ—Å—Ç–µ —Å CSV —Å–æ–∑–¥–∞–µ—Ç—Å—è –º–µ—Ç–∞—Ñ–∞–π–ª `.meta`:
```json
{
    "original_filename": "report_2024.xlsx",
    "processed_date": "2024-01-15T10:30:00Z",
    "email_sender": "reports@company.com",
    "email_date": "2024-01-15T09:00:00Z",
    "file_size_bytes": 15342,
    "rows_count": 1250,
    "md5_hash": "a1b2c3d4e5f6...",
    "processing_duration_ms": 1250
}
```

---

## üì§ **–®–ê–ì 5: –ó–ê–ì–†–£–ó–ö–ê –ù–ê SFTP –°–ï–†–í–ï–†**

### **–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏:**
1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ SFTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** (SSH –∫–ª—é—á –∏–ª–∏ –ø–∞—Ä–æ–ª—å)
2. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–ø–æ–∫** –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
3. **–ó–∞–≥—Ä—É–∑–∫–∞ CSV —Ñ–∞–π–ª–∞** –≤ —Ü–µ–ª–µ–≤—É—é –ø–∞–ø–∫—É
4. **–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞—Ñ–∞–π–ª–∞** —Ä—è–¥–æ–º —Å CSV
5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏** (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ö–µ—à–µ–π)

### **Retry –ª–æ–≥–∏–∫–∞:**
```python
async def upload_with_retry(file_path: str, remote_path: str, max_retries: int = 3):
    for attempt in range(max_retries):
        try:
            success = await sftp_client.upload(file_path, remote_path)
            if success and await verify_upload(file_path, remote_path):
                return True
        except Exception as e:
            delay = 2 ** attempt  # Exponential backoff
            await asyncio.sleep(delay)
            log_warning(f"Upload attempt {attempt + 1} failed: {e}")

    return False
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏:**
- **MD5 —Ö–µ—à** –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
- **MD5 —Ö–µ—à** –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
- **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤** —Ñ–∞–π–ª–æ–≤
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞** –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ

---

## üíæ **–®–ê–ì 6: –°–û–•–†–ê–ù–ï–ù–ò–ï –ú–ï–¢–ê–î–ê–ù–ù–´–• –í –ë–î**

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:**
```sql
-- –¢–∞–±–ª–∏—Ü–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
INSERT INTO processed_files (
    message_id,
    sender_email,
    file_name,
    file_path,
    csv_path,
    sftp_uploaded,
    file_hash,
    processed_at,
    email_date,
    processing_duration_ms,
    file_size_bytes,
    rows_count
) VALUES (
    '${email.message_id}',
    '${email.sender}',
    '${original_filename}',
    '${local_path}',
    '${remote_path}',
    true,
    '${md5_hash}',
    NOW(),
    '${email.date}',
    ${duration},
    ${file_size},
    ${rows}
);
```

### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π:**
```sql
-- –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π
INSERT INTO operation_logs (
    operation_type,
    status,
    message,
    context,
    created_at
) VALUES (
    'file_processing',
    'SUCCESS',
    'File processed successfully',
    '{"file": "RS_stoplist_20240115.csv", "duration": 1250}',
    NOW()
);
```

---

## üì® **–®–ê–ì 7: –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô**

### **–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**

#### **‚úÖ SUCCESS (–£—Å–ø–µ—Ö):**
```
üìä –û–ë–†–ê–ë–û–¢–ö–ê –§–ê–ô–õ–ê –ó–ê–í–ï–†–®–ï–ù–ê

–§–∞–π–ª: RS_stoplist_20240115.csv
–ò—Å—Ç–æ—á–Ω–∏–∫: reports@company.com
–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 1.25 —Å–µ–∫
–°—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö: 1,250
–†–∞–∑–º–µ—Ä: 15.3 KB
SFTP –ø—É—Ç—å: ps/2024/01/15/RS_stoplist_20240115.csv

‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ SFTP: –£—Å–ø–µ—à–Ω–æ
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏: –ü—Ä–æ–π–¥–µ–Ω–∞
‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã
```

#### **‚ùå ERROR (–û—à–∏–±–∫–∞):**
```
üö® –û–®–ò–ë–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –§–ê–ô–õ–ê

–§–∞–π–ª: corrupted_report.xlsx
–ò—Å—Ç–æ—á–Ω–∏–∫: reports@company.com
–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å Excel —Ñ–∞–π–ª
–í—Ä–µ–º—è: 2024-01-15 10:30:00

‚ùå –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: –ü—Ä–æ–≤–∞–ª–µ–Ω–∞
‚ö†Ô∏è –§–∞–π–ª –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω
üìû –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
```

#### **‚ö†Ô∏è WARNING (–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ):**
```
‚ö†Ô∏è –ù–ï–°–¢–ê–ù–î–ê–†–¢–ù–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø

–§–∞–π–ª: large_report.xlsx
–†–∞–∑–º–µ—Ä: 48.5 MB (–±–ª–∏–∑–∫–æ –∫ –ª–∏–º–∏—Ç—É 50 MB)
–û–±—Ä–∞–±–æ—Ç–∫–∞: –£—Å–ø–µ—à–Ω–∞, –Ω–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 12.5 —Å–µ–∫ (–≤—ã—à–µ –Ω–æ—Ä–º—ã)

üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
```

### **–ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏:**
1. **Email** ‚Üí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
2. **Telegram** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚Üí –î–ª—è –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

## üìä **–®–ê–ì 8: –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –ú–ï–¢–†–ò–ö–ò**

### **–°–æ–±–∏—Ä–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
```python
# Prometheus –º–µ—Ç—Ä–∏–∫–∏
emails_processed_total = Counter('emails_processed_total')
files_converted_total = Counter('files_converted_total')
sftp_uploads_total = Counter('sftp_uploads_total')
processing_duration_seconds = Histogram('processing_duration_seconds')
errors_by_type = Counter('errors_by_type', ['error_type'])
file_size_bytes = Histogram('file_size_bytes')
```

### **Health Checks:**
- **/health/live** ‚Üí –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ
- **/health/ready** ‚Üí –ì–æ—Ç–æ–≤–æ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ (–ë–î, SFTP –¥–æ—Å—Ç—É–ø–Ω—ã)
- **/health/detailed** ‚Üí –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

---

## ‚öôÔ∏è **–ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ù–ê–°–¢–†–û–ô–ö–ò**

### **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞:**
```yaml
scheduler:
  interval_hours: 1           # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—á—Ç—ã
  timezone: "UTC"             # –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞
  max_concurrent_jobs: 1      # –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
  misfire_grace_time: 300     # –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
```

### **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤:**
```yaml
file_processing:
  max_file_size_mb: 50        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
  temp_directory: "/tmp"      # –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
  csv_encoding: "utf-8-sig"   # –ö–æ–¥–∏—Ä–æ–≤–∫–∞ CSV
  csv_separator: ","          # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å CSV
  cleanup_temp_files: true    # –£–¥–∞–ª—è—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
```

---

## üîÑ **FLOW –î–ò–ê–ì–†–ê–ú–ú–ê –ü–†–ò–ù–Ø–¢–ò–Ø –†–ï–®–ï–ù–ò–ô**

```mermaid
flowchart TD
    Start([üéØ –ó–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é]) --> Email{üìß –ù–æ–≤—ã–µ –ø–∏—Å—å–º–∞?}
    Email -->|–ù–µ—Ç| Wait[‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞]
    Email -->|–î–∞| Sender{üë§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –≤ whitelist?}

    Sender -->|–ù–µ—Ç| Skip[‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫ –ø–∏—Å—å–º–∞]
    Sender -->|–î–∞| Attach{üìé –ï—Å—Ç—å .xlsx?}

    Attach -->|–ù–µ—Ç| Skip
    Attach -->|–î–∞| Dup{üîç –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω?}

    Dup -->|–î–∞| Skip
    Dup -->|–ù–µ—Ç| Size{üìè –†–∞–∑–º–µ—Ä OK?}

    Size -->|–ù–µ—Ç| Error[‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—Ä–∞]
    Size -->|–î–∞| Convert[üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è]

    Convert --> Success{‚úÖ –£—Å–ø–µ—à–Ω–æ?}
    Success -->|–ù–µ—Ç| Error
    Success -->|–î–∞| Upload[üì§ –ó–∞–≥—Ä—É–∑–∫–∞ SFTP]

    Upload --> UploadOK{‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ?}
    UploadOK -->|–ù–µ—Ç| Retry{üîÑ –ü–æ–≤—Ç–æ—Ä?}
    Retry -->|–î–∞| Upload
    Retry -->|–ù–µ—Ç| Error

    UploadOK -->|–î–∞| Verify[üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏]
    Verify --> VerifyOK{‚úÖ –•–µ—à–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç?}

    VerifyOK -->|–ù–µ—Ç| Error
    VerifyOK -->|–î–∞| DB[üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î]

    DB --> Notify[üì® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è]
    Error --> Notify

    Notify --> Metrics[üìä –ú–µ—Ç—Ä–∏–∫–∏]
    Skip --> Metrics
    Wait --> Metrics

    Metrics --> End([üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ü–∏–∫–ª–∞])
    End --> Start
```

---

## üéõÔ∏è **–†–ï–ñ–ò–ú–´ –†–ê–ë–û–¢–´**

### **üü¢ –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∫–∞–∂–¥—ã–π —á–∞—Å
- –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —à—Ç–∞—Ç–Ω–æ
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö

### **üü° –†–µ–∂–∏–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:**
- –ü–æ—Å–ª–µ —Å–±–æ–µ–≤ –∏–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—è
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∫–æ–ø–∏–≤—à–∏—Ö—Å—è –ø–∏—Å–µ–º
- –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### **üî¥ –†–µ–∂–∏–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è:**
- –ü–ª–∞–Ω–æ–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –¢–æ–ª—å–∫–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ health checks
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–µ–∂–∏–º–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

### **üü† –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–∂–∏–º:**
- –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

---

## üìà **–ö–õ–Æ–ß–ï–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–ò (KPI)**

### **–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞**: < 5 —Å–µ–∫—É–Ω–¥ (–Ω–æ—Ä–º–∞)
- **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏**: > 99.5%
- **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã**: > 99.9%
- **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è**: < 5 –º–∏–Ω—É—Ç

### **–ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏:**
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ –¥–µ–Ω—å**: –¶–µ–ª—å
- **–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏**: vs —Ä—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- **–°–Ω–∏–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫**: vs —Ä—É—á–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å
- **–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: –û–ø—Ä–æ—Å—ã

---

## üö® **–û–ë–†–ê–ë–û–¢–ö–ê –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–´–• –°–ò–¢–£–ê–¶–ò–ô**

### **–°—Ü–µ–Ω–∞—Ä–∏–∏ –∏ —Ä–µ–∞–∫—Ü–∏–∏:**

| –°–∏—Ç—É–∞—Ü–∏—è | –†–µ–∞–∫—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
|----------|-----------------|-------------|
| SFTP –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ + retry | WARNING ‚Üí CRITICAL |
| –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ | –§–∞–π–ª–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | CRITICAL |
| –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π Excel | –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω | ERROR |
| –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞ | –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ | WARNING |
| –°–µ—Ç–µ–≤—ã–µ —Å–±–æ–∏ | Exponential backoff | WARNING |
| –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ | Throttling + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ | WARNING |

---

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï**

### **–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –∑–∞–¥–∞—á–∏:**
- **–ï–∂–µ–¥–Ω–µ–≤–Ω–æ**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫
- **–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ**: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- **–ï–∂–µ–º–µ—Å—è—á–Ω–æ**: –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –ë–î
- **–ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
- **CPU/Memory**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- **Disk Space**: –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ
- **Network**: –°–µ—Ç–µ–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
- **Dependencies**: –°—Ç–∞—Ç—É—Å –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

–≠—Ç–æ—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—É—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ Excel-—Ñ–∞–π–ª–æ–≤ —Å –ø–æ–ª–Ω—ã–º –∞—É–¥–∏—Ç–æ–º –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞.
